<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: SurveyResponse
  
    &mdash; Documentation by YARD 0.8.3
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!" + escape(window.location.href);
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (S)</a> &raquo;
    
    
    <span class="title">SurveyResponse</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: SurveyResponse
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">ActiveRecord::Base</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">ActiveRecord::Base</li>
          
            <li class="next">SurveyResponse</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">app/models/survey_models/survey_response.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Represents a single sent of answers to the questions contained within a
SurveyVersion. Where a SurveyVersion contains DisplayFields representing
the columns in the response (and custom fields), the SurveyResponse
contains DisplayFieldValues for each of those DisplayFields. In addition,
the SurveyResponse links to the RawResponses, which are the historical and
unedited responses as entered by the survey taker.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Author:</p>
<ul class="author">
  
    <li>
      
      
      
      
        
        <div class='inline'>
<p>Communication Training Analysis Corporation &lt;info@ctacorp.com&gt;</p>
</div>
      
    </li>
  
</ul>

</div>






  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_next_response-class_method" title="get_next_response (class method)">+ (nil, SurveyResponse) <strong>get_next_response</strong>(worker_name, mode, *date) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Used by the response_parser rake task to select SurveyResponses in sequence
for processing of nightly Rules.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_response-class_method" title="process_response (class method)">+ (Object) <strong>process_response</strong>(response, survey_version_id) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Create a SurveyResponse from the RawResponse.</p>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#archive-instance_method" title="#archive (instance method)">- (Object) <strong>archive</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Mark the SurveyResponse as archived (soft deleted.).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_me-instance_method" title="#process_me (instance method)">- (Object) <strong>process_me</strong>(*trigger_id) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Process all rules for the SurveyVersion and apply them to this
SurveyResponse.</p>
</div></span>
  
</li>

      
    </ul>
  


  

  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="get_next_response-class_method">
  
    + (<tt>nil</tt>, <tt><span class='object_link'><a href="" title="SurveyResponse (class)">SurveyResponse</a></span></tt>) <strong>get_next_response</strong>(worker_name, mode, *date) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Used by the response_parser rake task to select SurveyResponses in sequence
for processing of nightly Rules.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>worker_name</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the worker thread name</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>date</span>
      
      
        <span class='type'>(<tt>Date</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>last run date, i.e. now</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>nil</tt>, <tt><span class='object_link'><a href="" title="SurveyResponse (class)">SurveyResponse</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the next SurveyResponse to process, if applicable</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/survey_models/survey_response.rb', line 128</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_get_next_response'>get_next_response</span><span class='lparen'>(</span><span class='id identifier rubyid_worker_name'>worker_name</span><span class='comma'>,</span> <span class='id identifier rubyid_mode'>mode</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_date'>date</span><span class='rparen'>)</span>
  <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Base</span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
    
    <span class='comment'># get next response (locking so we can stop other workers from grabbing it)
</span>    <span class='id identifier rubyid_response'>response</span> <span class='op'>=</span> <span class='const'>SurveyResponse</span><span class='period'>.</span><span class='id identifier rubyid_find_by_worker_name'>find_by_worker_name</span><span class='lparen'>(</span><span class='id identifier rubyid_worker_name'>worker_name</span><span class='comma'>,</span> <span class='symbol'>:lock</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span>
    
    <span class='kw'>if</span> <span class='id identifier rubyid_mode'>mode</span> <span class='op'>==</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>new</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_nr_id'>nr_id</span> <span class='op'>=</span> <span class='const'>NewResponse</span><span class='period'>.</span><span class='id identifier rubyid_next_response'>next_response</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_try'>try</span><span class='lparen'>(</span><span class='symbol'>:survey_response_id</span><span class='rparen'>)</span>
      <span class='kw'>return</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_nr_id'>nr_id</span>
      <span class='id identifier rubyid_response'>response</span> <span class='op'>||=</span> <span class='const'>SurveyResponse</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_nr_id'>nr_id</span><span class='comma'>,</span> <span class='symbol'>:lock</span> <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_mode'>mode</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>nightly</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_response'>response</span> <span class='op'>||=</span> <span class='const'>SurveyResponse</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>last_processed &lt; ? </span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_date'>date</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
      <span class='kw'>return</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_response'>response</span>
    <span class='kw'>end</span>
    
    <span class='comment'># set its status and worker
</span>    <span class='id identifier rubyid_response'>response</span><span class='period'>.</span><span class='id identifier rubyid_update_attributes'>update_attributes</span><span class='lparen'>(</span><span class='symbol'>:status_id</span> <span class='op'>=&gt;</span> <span class='const'>Status</span><span class='op'>::</span><span class='const'>PROCESSING</span><span class='comma'>,</span> <span class='symbol'>:worker_name</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_worker_name'>worker_name</span><span class='rparen'>)</span>
    
    <span class='comment'># return the reponse
</span>    <span class='id identifier rubyid_response'>response</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_response-class_method">
  
    + (<tt>Object</tt>) <strong>process_response</strong>(response, survey_version_id) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Create a SurveyResponse from the RawResponse.  This is used by Delayed::Job
to process the survey responses asynchronously.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>response</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the response parameter hash to process from the controller</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>survey_version_id</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>the id of the SurveyVersion</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


73
74
75
76
77
78
79
80
81
82
83
84
85
86
87</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/survey_models/survey_response.rb', line 73</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_process_response'>process_response</span><span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='comma'>,</span> <span class='id identifier rubyid_survey_version_id'>survey_version_id</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_client_id'>client_id</span> <span class='op'>=</span> <span class='const'>SecureRandom</span><span class='period'>.</span><span class='id identifier rubyid_hex'>hex</span><span class='lparen'>(</span><span class='int'>64</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_survey_response'>survey_response</span> <span class='op'>=</span> <span class='const'>SurveyResponse</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='lparen'>(</span><span class='lbrace'>{</span><span class='symbol'>:client_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_client_id'>client_id</span><span class='comma'>,</span> <span class='symbol'>:survey_version_id</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_survey_version_id'>survey_version_id</span><span class='rbrace'>}</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='id identifier rubyid_response'>response</span><span class='rparen'>)</span><span class='rparen'>)</span>

  <span class='comment'>## Work around for associating the child raw responses with the survey_response
</span>  <span class='id identifier rubyid_survey_response'>survey_response</span><span class='period'>.</span><span class='id identifier rubyid_raw_responses'>raw_responses</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_raw_response'>raw_response</span><span class='op'>|</span>
    <span class='id identifier rubyid_raw_response'>raw_response</span><span class='period'>.</span><span class='id identifier rubyid_client_id'>client_id</span> <span class='op'>=</span> <span class='id identifier rubyid_client_id'>client_id</span>
    <span class='id identifier rubyid_raw_response'>raw_response</span><span class='period'>.</span><span class='id identifier rubyid_survey_response'>survey_response</span> <span class='op'>=</span> <span class='id identifier rubyid_survey_response'>survey_response</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_survey_response'>survey_response</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>

  <span class='id identifier rubyid_survey_response'>survey_response</span><span class='period'>.</span><span class='id identifier rubyid_process_me'>process_me</span> <span class='int'>1</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="archive-instance_method">
  
    - (<tt>Object</tt>) <strong>archive</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Mark the SurveyResponse as archived (soft deleted.)</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


152
153
154
155</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/survey_models/survey_response.rb', line 152</span>

<span class='kw'>def</span> <span class='id identifier rubyid_archive'>archive</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_archived'>archived</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_save!'>save!</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_me-instance_method">
  
    - (<tt>Object</tt>) <strong>process_me</strong>(*trigger_id) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Process all rules for the SurveyVersion and apply them to this
SurveyResponse. Passing no parameters will evaluate all Rules regardless of
ExecutionTrigger.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>trigger_id</span>
      
      
        <span class='type'>(<tt>Array&lt;Integer&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'>
<p>splat of ExecutionTrigger id parameters</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/models/survey_models/survey_response.rb', line 93</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_me'>process_me</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_trigger_id'>trigger_id</span><span class='rparen'>)</span>

  <span class='comment'>#if no triggers specified, do them all
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_trigger_id'>trigger_id</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span> <span class='op'>==</span> <span class='int'>0</span>
    <span class='id identifier rubyid_trigger_id'>trigger_id</span> <span class='op'>=</span> <span class='const'>ExecutionTrigger</span><span class='period'>.</span><span class='id identifier rubyid_all'>all</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_et'>et</span><span class='op'>|</span> <span class='id identifier rubyid_et'>et</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='kw'>begin</span>
    <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Base</span><span class='period'>.</span><span class='id identifier rubyid_transaction'>transaction</span> <span class='kw'>do</span>
      <span class='const'>Rule</span><span class='period'>.</span><span class='id identifier rubyid_find_all_by_survey_version_id'>find_all_by_survey_version_id</span><span class='lparen'>(</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_survey_version_id'>survey_version_id</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_rule'>rule</span><span class='op'>|</span>
        <span class='kw'>begin</span>
          <span class='id identifier rubyid_rule'>rule</span><span class='period'>.</span><span class='id identifier rubyid_apply_me'>apply_me</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
          <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_update_attributes'>update_attributes</span><span class='lparen'>(</span><span class='symbol'>:status_id</span> <span class='op'>=&gt;</span> <span class='const'>Status</span><span class='op'>::</span><span class='const'>DONE</span><span class='comma'>,</span> <span class='symbol'>:last_processed</span> <span class='op'>=&gt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span>
        <span class='kw'>rescue</span>
          <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Processing Failed - </span><span class='embexpr_beg'>#{</span><span class='gvar'>$!</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_update_attributes'>update_attributes</span><span class='lparen'>(</span><span class='symbol'>:status_id</span> <span class='op'>=&gt;</span> <span class='const'>Status</span><span class='op'>::</span><span class='const'>ERROR</span><span class='comma'>,</span> <span class='symbol'>:worker_name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:last_processed</span> <span class='op'>=&gt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Processing Failed - </span><span class='embexpr_beg'>#{</span><span class='gvar'>$!</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># do record keeping (status is already set, so we need to remove worker name and new response record
</span>  <span class='id identifier rubyid_sql'>sql</span> <span class='op'>=</span> <span class='const'>ActiveRecord</span><span class='op'>::</span><span class='const'>Base</span><span class='period'>.</span><span class='id identifier rubyid_connection'>connection</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='semicolon'>;</span>
  <span class='id identifier rubyid_sql'>sql</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>delete from new_responses where survey_response_id = </span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_update_attributes'>update_attributes</span><span class='lparen'>(</span><span class='symbol'>:worker_name</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='symbol'>:last_processed</span> <span class='op'>=&gt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.3 (ruby-1.9.3).
</div>

  </body>
</html>